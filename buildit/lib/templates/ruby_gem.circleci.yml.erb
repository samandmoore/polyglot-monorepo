"<%= app_name %>-test":
  parallelism: 2
  docker:
    - image: circleci/ruby:<%= ruby_version %>
      environment:
        RAILS_ENV: test
        RACK_ENV: test
  steps:
    - checkout
    - restore-cache:
        keys:
          - v0-<%= app_name %>-deps-{{ checksum "<%= app_name %>/<%= app_name %>.gemspec" }}
          - v0-<%= app_name %>-deps-
    - run:
        name: install dependencies
        command: |
          cd <%= app_name %>
          bundle install --jobs 4 --path vendor/bundle
    - save-cache:
        key: v0-<%= app_name %>-deps-{{ checksum "<%= app_name %>/<%= app_name %>.gemspec" }}
        paths:
          - <%= app_name %>/vendor/bundle
    - run:
        name: run tests
        command: |
          cd <%= app_name %>
          export SPEC=$(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings | tr '\r\n' ' ')
          export SPEC_OPTS="--profile 10 --format RspecJunitFormatter --out /tmp/test-results/rspec.xml --format progress"
          bundle exec rake
    - store_test_results:
        path: /tmp/test-results
        destination: test-results
    - store_artifacts:
        path: /tmp/test-results
        destination: test-results
